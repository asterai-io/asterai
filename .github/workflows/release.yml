name: Release
on:
  release:
    types: [ published ]
env:
  CARGO_TERM_COLOR: always
jobs:
  # Build all platforms first (fail-fast).
  build:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            npm-dir: linux-x64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            npm-dir: linux-arm64
            cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            npm-dir: darwin-x64
          - target: aarch64-apple-darwin
            os: macos-latest
            npm-dir: darwin-arm64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            npm-dir: win32-x64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux ARM64)
        if: matrix.cross
        uses: taiki-e/install-action@cross

      - name: Build (native)
        if: ${{ !matrix.cross }}
        run: cargo build --release --target ${{ matrix.target }} -p asterai

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }} -p asterai

      - name: Prepare binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/asterai dist/
          chmod +x dist/asterai

      - name: Prepare binary (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir dist
          copy target\${{ matrix.target }}\release\asterai.exe dist\

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.npm-dir }}
          path: dist/
          if-no-files-found: error

  # Publish to crates.io after all builds succeed.
  publish-crates:
    name: Publish to crates.io
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update versions in Cargo.toml
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.version }}"/' asterai/Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.version }}"/' cli/Cargo.toml

      - name: Publish asterai_runtime
        run: |
          OUTPUT=$(cargo publish -p asterai_runtime --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists"; then
              echo "asterai_runtime already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io index update
        run: sleep 30

      - name: Update dependency version
        run: |
          sed -i 's|asterai_runtime = { path = "../asterai" }|asterai_runtime = "${{ steps.version.outputs.version }}"|' cli/Cargo.toml

      - name: Publish asterai
        run: |
          OUTPUT=$(cargo publish -p asterai --allow-dirty --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists"; then
              echo "asterai already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

  # Publish to npm after crates.io succeeds.
  publish-npm:
    name: Publish to npm
    needs: publish-crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Prepare npm packages
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update versions in all package.json files.
          for pkg in npm/*/package.json; do
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" "$pkg"
          done

          # Update optionalDependencies versions in main package.
          sed -i "s/\"@asterai-io\/cli-[^\"]*\": \"[^\"]*\"/\"@asterai-io\/cli-linux-x64\": \"$VERSION\"/g; \
                  s/\"@asterai-io\/cli-linux-arm64\": \"[^\"]*\"/\"@asterai-io\/cli-linux-arm64\": \"$VERSION\"/g; \
                  s/\"@asterai-io\/cli-darwin-x64\": \"[^\"]*\"/\"@asterai-io\/cli-darwin-x64\": \"$VERSION\"/g; \
                  s/\"@asterai-io\/cli-darwin-arm64\": \"[^\"]*\"/\"@asterai-io\/cli-darwin-arm64\": \"$VERSION\"/g; \
                  s/\"@asterai-io\/cli-win32-x64\": \"[^\"]*\"/\"@asterai-io\/cli-win32-x64\": \"$VERSION\"/g" \
            npm/asterai/package.json

          # Copy binaries to npm package directories.
          mkdir -p npm/linux-x64/bin
          mkdir -p npm/linux-arm64/bin
          mkdir -p npm/darwin-x64/bin
          mkdir -p npm/darwin-arm64/bin
          mkdir -p npm/win32-x64/bin

          cp artifacts/binary-linux-x64/asterai npm/linux-x64/bin/
          cp artifacts/binary-linux-arm64/asterai npm/linux-arm64/bin/
          cp artifacts/binary-darwin-x64/asterai npm/darwin-x64/bin/
          cp artifacts/binary-darwin-arm64/asterai npm/darwin-arm64/bin/
          cp artifacts/binary-win32-x64/asterai.exe npm/win32-x64/bin/

          # Make binaries executable.
          chmod +x npm/linux-x64/bin/asterai
          chmod +x npm/linux-arm64/bin/asterai
          chmod +x npm/darwin-x64/bin/asterai
          chmod +x npm/darwin-arm64/bin/asterai

      - name: Publish npm packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          publish_if_not_exists() {
            local pkg=$1
            local dir=$2
            if npm view "$pkg@$VERSION" version 2>/dev/null; then
              echo "$pkg@$VERSION already published, skipping"
            else
              cd "$dir" && npm publish --access public && cd -
            fi
          }

          publish_if_not_exists "@asterai-io/cli-linux-x64" "npm/linux-x64"
          publish_if_not_exists "@asterai-io/cli-linux-arm64" "npm/linux-arm64"
          publish_if_not_exists "@asterai-io/cli-darwin-x64" "npm/darwin-x64"
          publish_if_not_exists "@asterai-io/cli-darwin-arm64" "npm/darwin-arm64"
          publish_if_not_exists "@asterai-io/cli-win32-x64" "npm/win32-x64"

          # Wait for registry propagation before publishing main package.
          sleep 10

          publish_if_not_exists "@asterai/cli" "npm/asterai"

  # Upload binaries to GitHub Release.
  upload-release-assets:
    name: Upload release assets
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Create archives for each platform.
          cd artifacts/binary-linux-x64
          tar -czvf ../../release/asterai-linux-x64.tar.gz asterai
          cd ../..

          cd artifacts/binary-linux-arm64
          tar -czvf ../../release/asterai-linux-arm64.tar.gz asterai
          cd ../..

          cd artifacts/binary-darwin-x64
          tar -czvf ../../release/asterai-darwin-x64.tar.gz asterai
          cd ../..

          cd artifacts/binary-darwin-arm64
          tar -czvf ../../release/asterai-darwin-arm64.tar.gz asterai
          cd ../..

          cd artifacts/binary-win32-x64
          zip ../../release/asterai-win32-x64.zip asterai.exe
          cd ../..

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
